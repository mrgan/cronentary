<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<title>Cronentary</title>
	<meta name="apple-mobile-web-app-title" content="Cronentary">
	<meta name="description" content="The soothing sounds of David Cronenberg's DVD commentary">
	<meta name="keywords" content="david cronenberg, cronenberg, commentary, dvd, existenx, videodrome, rabid, scanners">
	
	<meta property="og:title" content="Cronentary" />
	<!-- <meta property="og:url" content="https://" /> -->
	<meta property="og:image" content="https://mrgan.github.io/cronentary/images/card.png" />
	<meta property="og:image:width" content="500" />
	<meta property="og:image:height" content="250" />
	<meta property="og:description" content="The soothing sounds of David Cronenberg's DVD commentary" />
	
	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:title" content="Cronentary">
	<meta name="twitter:description" content="The soothing sounds of David Cronenberg's DVD commentary">
	<meta name="twitter:image" content="https://mrgan.github.io/cronentary/images/card.png">
	
	<link rel="apple-touch-icon-precomposed" href="images/icon.png" />
	<link rel="icon" type="image/png" href="images/icon-small.png">
	
	<style>
	
	:root
	{	
		--page-bg: #f14b31;
		--text: #fef210;
	}
	
	/* P3 variants */
	@supports (color: color(display-p3 1 1 1 / 1))
	{
		:root
		{
			--page-bg: color(display-p3 0.945 0.294 0.192);
			--text: color(display-p3 1 0.95 0.063);
		}
	}
	
	body
	{
		background-color: var(--page-bg);
		color: var(--text);
	
		font-family: 'Menlo', 'Consolas', monospace;
		font-weight: 700;
		font-size: 1em;
		line-height: 1.5em;
	}
	
	h1#title
	{
		color: transparent;
		text-indent: -9999px;

		position: relative;
		height: 2.5em;
		max-width: 80%;
		margin: 1em auto .25em auto;

		background-repeat: no-repeat;
		background-position: center center;
		background-size: contain;
		background-image: url('images/title.png');
		
		pointer-events: none;
	}
	
	main
	{		
		position: absolute;
		display: grid;
		place-content: center;
		
		top: 0;
		left: 0;		
		width: 100%;
		height: 100%; */
	}
	
	#bed
	{
		width: 96%;
		max-width: 50em;
		margin: 0 auto 1em auto;
		
		pointer-events: none;
	}
	
	#controls
	{				
		width: 100%;
		margin: 0 auto -8vh auto;
		text-align: center;
		
		/* background: yellow; */
	}
		#controls .control
		{
			display: inline-block;			
			width: auto;
			width: 30vw;
			max-width: 40%;
			margin: 0 10% 0 auto;
		}
		#controls .control.hidden
		{
			display: none;
		}
		
		.blobby
		{
			animation-duration: 4000ms;
			animation-iteration-count: infinite;
			animation-timing-function: steps(5, jump-both);
			animation-direction: alternate;
			animation-name: blobble;
			transform: scale(1,1);
		}
			@keyframes blobble
			{
				0% { transform: scale(1,1); }
				30% { transform: scale(1.08, .93); }
				70% { transform: scale(.94, 1.12);}
				100% { transform: scale(1.07, .95);}
			}
	
	#labelTitle
	{
		display: block;
		height: 1.5em;
		margin-bottom: .75em;
		
		font-size: 1.25em;
		text-align: center;
		
		color: rgba(0,0,0,.4);
	}
	
	footer
	{
		margin-top: 1em;
		text-align: center;
		color: var(--subtle);
	}
	
	#sleep
	{
		width: 60%;
		height: 4em;
		max-width: 20em;
		margin: 1em auto;
		
		position: relative;
		
		/* background-color: rgba(50,80,90,.3); */
		background-repeat: no-repeat;
		background-position: center center;
		background-size: contain;
		background-image: url('images/sleep-track.png');
	}
		#sleep button
		{
			position: absolute;
			-webkit-appearance: none;
			
			width: 3em;
			height: 3em;
			top: calc(50% - 1.5em);			
			border: 0;
			border-radius: 1.5em;
			background: transparent;
			/* outline: 1px solid white; */
		}
			
		#sleep #sleepOff
		{
			left: 0;			
		}
		#sleep #sleep15
		{
			left: calc(25% - 1.5em);
		}
		#sleep #sleep30
		{
			left: calc(50% - 1.5em);
		}
		#sleep #sleep60
		{
			right: 0;
		}
		
		#sleep button:active::after
		{
			content:'';
			display: block;
			width: 1.2em;
			height: 1.2em;
			border-radius: .6em;
			background: var(--text);
		}
			#sleep #sleepOff::after
			{
				margin-left: -.1em;
			}
			#sleep #sleep15::after,
			#sleep #sleep30::after
			{
				margin-left: .2em;
			}
			#sleep #sleep60::after
			{
				margin-left: .6em;
			}
		
		#sleep::before
		{
			content:'';
			display: block;
			position: relative;
			left: -2.75em;
			top: .45em;
			width: 2.5em;
			height: 2.5em;			
		
			/* background-color: rgba(50,80,90,.3); */
			background-repeat: no-repeat;
			background-position: center center;
			background-size: contain;
			background-image: url('images/sleep-zzz.png');
			
			pointer-events: none;
		}
		#sleep::after
		{
			content:'';
			display: block;
			width: 100%;
			height: 2em;
			margin: 1em auto 0 auto;

			background-repeat: no-repeat;
			background-position: center center;
			background-size: contain;
			background-image: url('images/sleep-labels.png');
			
			pointer-events: none;
		}
		
		#sleep #sleepProgress
		{
			position: absolute;
			top: 0;
			right: 0;
			height: 100%;
			background-color: var(--page-bg);
			opacity: .5;
			/* visibility: hidden; */
		}
	
	#nightOverlay
	{
		position: absolute;
		
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		
		background: var(--night-overlay);
		mix-blend-mode: hue;
		
		pointer-events: none;
		z-index: 9999;
	}
	
	/* Desktop scale */
	@media screen and (min-width: 640px)
	{
		body
		{
			font-size: 1em;	
			padding-top: 6vh;
		}
	}
	
	@media (prefers-color-scheme: dark)
	{
		:root
		{
			--page-bg: #000000;
			--text: #e8e8e8;
			--bright-bg: black;
			--subtle: #666666;
			
			--night-overlay: #2a619e;
		}
		
		h1#title
		{
			filter: brightness(.5);
		}
		
		#sleep
		{
			filter: brightness(3);
		}
	}
	
	</style>
	
	<script src="clips.js"></script>
	
</head>

<body class="" onload="init()">
	
	<main id="content">
		
		<header>
			
			<h1 id="title">
				CRONENTARY
			</h1>
			<span id="labelTitle"></span>
			
		</header>
		
		<div id="controls">			
			<img id="btnPlay" class="control" src="images/play.png" onclick="playPause()">
			<img id="btnPause" class="control hidden" src="images/pause.png" onclick="playPause()">						
		</div>
		
		<img src="images/bed.png" id="bed">
		
		<div id="sleep">
			<div id="sleepProgress" style="width: 100%"></div>
			<button id="sleepOff" onclick="stopSleepTimer()"></button>
			<button id="sleep15"  onclick="startSleepTimer(15)"></button>
			<button id="sleep30"  onclick="startSleepTimer(30)"></button>
			<button id="sleep60"  onclick="startSleepTimer(60)"></button>			
		</div>
		
	</main>
	
	<footer>
		
		
		
	</footer>
	
	<div id="nightOverlay"></div>
	
</body>

<script>
	
	// Start
	
	const clipsPath = 'clips/';
	
	var c = 0;
	var autoplay = false;
	var firstLoaded = false;
	var playing = false;
	
	
	var sleepTimerOn = false; // in ms
	var sleepTimerLength = 0; // in ms
	var sleepTimerMaxLength = 60 * 60 * 1000; // 60 mins max
	var sleepTimerElapsed = 0; // in ms
	
	var currentTitle = '';
	
	var tTick;
	
	// Elements
	
	const btnPlay = document.getElementById('btnPlay');
	const btnPause = document.getElementById('btnPause');
	
	const labelTitle = document.getElementById('labelTitle');
	
	const sleepProgress = document.getElementById('sleepProgress');
	
	function shuffle(array)
	{
		for (let i = array.length - 1; i > 0; i--)
		{
			const j = Math.floor(Math.random() * (i + 1));
			[array[i], array[j]] = [array[j], array[i]];
		}
	}
	
	
	shuffle(clips);
	
	const audioElement = new Audio();
	
	// Clip finished
	audioElement.addEventListener("ended", nextClip);
	
	// If playback is stopped/started by the OS
	audioElement.addEventListener("play", playHappened);
	audioElement.addEventListener("pause", pauseHappened);
	
	function nextClip()
	{
		c++;
		if (c >= clips.length-1)
		{
			c = 0;
		}
		console.log("Next up, " + clips[c])
		loadClip(autoplay);
	}

	
	function loadClip(playImmediately)
	{			
		audioElement.src = clipsPath + clips[c];
		audioElement.load();
		console.log("Loaded " + clipsPath + clips[c]);
		
		// get name
		if (clips[c].indexOf('crash') > -1)
		{
			currentTitle = 'Crash (1996)';
		}
		else if (clips[c].indexOf('The Fly') > -1)
		{
			currentTitle = 'The Fly (1986)';
		}
		else if (clips[c].indexOf('Rabid') > -1)
		{
			currentTitle = 'Rabid (1977)';
		}
		else if (clips[c].indexOf('VidDrome') > -1)
		{
			currentTitle = 'Videodrome (1983)';
		}
		
		if (playImmediately)
		{
			playClip();
		}
	}
	
	function playHappened()
	{
		console.log("Entering play mode");
		
		playing = true;
		
		if (!firstLoaded)
		{				
			btnPlay.classList.toggle('hidden');
			firstLoaded = true;				
		}
		
		console.log("Playing " + c + ", " + clips[c]);	  
		
		btnPlay.classList.add('hidden');			
		btnPause.classList.remove('hidden');
		// btnPause.classList.add('blobby');
		
		if (sleepTimerOn)
		{
			tTick = setInterval(tick, 1000); // update every 1 s
		}
	}
	
	function pauseHappened()
	{
		playing = false;
		
		console.log("Pausing " + clips[c]);	  
		
		btnPlay.classList.remove('hidden');			
		btnPause.classList.add('hidden');
		// btnPause.classList.remove('blobby');
		
		clearInterval(tTick);
	}
	
	function playClip()
	{
		playHappened();
		audioElement.play();	
		if (currentTitle != '')
		{
			labelTitle.innerText = currentTitle;
		}
	}
	
	function pauseClip()
	{
		pauseHappened();
		audioElement.pause();
	}
	
	function playPause()
	{
		console.log('Attempting to play/pause');
		
		if (!audioElement.paused)
		{
			// Pause
			console.log("Will pause");
			pauseClip();
			autoplay = false;			
		}
		else
		{
			// Play
			console.log("Will play");
			playClip();
			autoplay = true; // the first time the user clicks play, they opt into autoplay			
		}
	}
	
	function startSleepTimer(mins)
	{
		sleepTimerLength = mins * 60 * 1000;
		sleepProgress.style.visibility = 'visible';
		
		tTick = setInterval(tick, 1000); // update every 1 s
		tick(); // update right away
	}
	
	function stopSleepTimer()
	{		
		pauseClip();
		
		sleepTimerOn = false;
		clearInterval(tTick);		
		
		sleepProgress.style.width = '100%';	// reset visually
		
		sleepTimerLength = 0;
		sleepTimerElapsed = 0; 
	}
	
	function tick()
	{
		if (playing)
		{		
			sleepTimerElapsed += 1000; // tick down one second	
			// console.log("One second on the timer…");
		}
		
		var timerLeft = sleepTimerLength - sleepTimerElapsed;
		
		if (timerLeft <= 0)
		{
			stopSleepTimer();
		}			
		
		sleepProgress.style.width = 100 - ((timerLeft/sleepTimerMaxLength)*100) + '%';		
		
		console.log("time left: " + (timerLeft/1000) + 's');
		console.log("width: " + sleepProgress.style.width);
		
		// console.log("tick");
	}
	
	function init()
	{
		shuffle(clips);
		
		loadClip();
	}
	
	
	
</script>

</html>